name: Security Scan â€“ Snyk + Semgrep + Trivy SBOM + OSV-Scanner + Licenses

on:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  fetch_repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.set.outputs.repos }}
    steps:
      - id: set
        run: |
          echo 'repos=["OWASP-Benchmark/BenchmarkJava","bkimminich/juice-shop","google/go-github"]' >> $GITHUB_OUTPUT

  scan_repo:
    needs: fetch_repos
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJSON(needs.fetch_repos.outputs.repos) }}

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git curl unzip openjdk-17-jdk maven nodejs npm golang
          pip3 install semgrep
          npm install -g snyk
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          go install github.com/google/osv-scanner/cmd/osv-scanner@v1.9.0
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          path: project
          fetch-depth: 1
          token: ${{ github.token }}

      - name: Best-effort dependency install
        run: |
          cd project
          if [ -f pom.xml ]; then mvn -B dependency:resolve || true; fi
          if [ -f package.json ]; then npm install || true; fi
          if [ -f requirements.txt ]; then pip3 install -r requirements.txt || true; fi

      - name: Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_SECRET }}
        run: |
          mkdir -p results
          snyk test --all-projects --json > results/sca.json || true

      - name: Semgrep
        run: |
          mkdir -p results
          semgrep --config p/security-audit --json > results/semgrep.json || true

      - name: Trivy + SBOM
        run: |
          mkdir -p results
          trivy fs project --format json --output results/sbom_vuln.json || true
          trivy fs project --format cyclonedx --output results/sbom.cdx.json || true

      - name: OSV
        run: |
          mkdir -p results
          osv-scanner -r project --format json > results/osv.json || true

      - name: Set artifact name
        id: name
        run: |
          SAFE=$(echo "${{ matrix.repo }}" | tr '/' '_')
          echo "artifact_name=$SAFE" >> $GITHUB_OUTPUT

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.name.outputs.artifact_name }}
          path: results

  benchmark_score:
    needs: scan_repo
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all_results

      - name: Ground truth
        run: |
          cat <<EOF > ground_truth.csv
          repo,expected
          OWASP-Benchmark_BenchmarkJava,274
          bkimminich_juice-shop,30
          google_go-github,5
          EOF

      - name: Compute recall
        run: |
          python3 <<'EOF'
          import pandas as pd, glob, json
          rows=[]
          for d in glob.glob("all_results/*"):
              repo=d.split("/")[-1]
              total=0
              try:
                  with open(f"{d}/sbom_vuln.json") as f:
                      data=json.load(f)
                      for r in data.get("Results",[]):
                          total+=len(r.get("Vulnerabilities",[]))
              except: pass
              rows.append([repo,total])
          df=pd.DataFrame(rows,columns=["repo","total"])
          gt=pd.read_csv("ground_truth.csv")
          m=gt.merge(df,on="repo")
          m["recall"]=(m["total"]/m["expected"]).round(3)
          print("\n=== BENCHMARK RESULTS ===\n")
          print(m)
          m.to_csv("benchmark_results.csv",index=False)
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.csv
